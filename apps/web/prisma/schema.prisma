generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  USER
  ADMIN
}

enum MasteryLevel {
  NOT_SEEN
  SEEN
  KNOWN
  MASTERED
}

enum VideoStatus {
  PROCESSING
  READY
  FAILED
}

enum UserVideoSlot {
  BEGINNER
  PROGRESS
}

model User {
  id           String   @id @default(cuid())
  email        String   @unique
  passwordHash String
  role         Role     @default(USER)
  createdAt    DateTime @default(now())
  lastLogin    DateTime?
  deletedAt    DateTime?

  preferences UserPreference?
  progresses  UserTechniqueProgress[]
  videos            UserTechniqueVideo[]
  views             UserTechniqueView[]
  createdVideoAssets VideoAsset[] @relation("VideoCreator")
  adminLogs         AdminAuditLog[] @relation("AdminActor")
}


model Belt {
  id         String   @id @default(cuid())
  code       String   @unique
  name       String
  orderIndex Int
  isActive   Boolean  @default(true)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  modules       Module[]
  content       BeltContent?
  userPreferences UserPreference[]
}

model BeltContent {
  id          String   @id @default(cuid())
  beltId      String   @unique
  contentRich String   // markdown (recommand√©)
  sourceRef   String?
  updatedAt   DateTime @updatedAt
  updatedBy   String?

  belt Belt @relation(fields: [beltId], references: [id], onDelete: Cascade)
}

model Module {
  id         String   @id @default(cuid())
  beltId     String
  title      String
  orderIndex Int
  isActive   Boolean  @default(true)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  belt       Belt      @relation(fields: [beltId], references: [id], onDelete: Cascade)
  techniques Technique[]
}

model Technique {
  id             String   @id @default(cuid())
  moduleId       String
  title          String
  orderIndex     Int
  descriptionRich String?
  keywords       String?
  isActive       Boolean  @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  module     Module @relation(fields: [moduleId], references: [id], onDelete: Cascade)
  progress   UserTechniqueProgress[]
  coachVideoLink TechniqueVideoLink?
  userVideos UserTechniqueVideo[]
  userViews  UserTechniqueView[]
}

model UserTechniqueProgress {
  id          String       @id @default(cuid())
  userId      String
  techniqueId String
  mastery     MasteryLevel @default(NOT_SEEN)
  updatedAt   DateTime     @updatedAt
  notes       String?

  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  technique Technique @relation(fields: [techniqueId], references: [id], onDelete: Cascade)

  @@unique([userId, techniqueId])
  @@index([userId])
  @@index([techniqueId])
}

model VideoAsset {
  id             String      @id @default(cuid())
  provider       String
  storageKey     String
  status         VideoStatus @default(PROCESSING)
  duration       Int?
  size           Int?
  format         String?
  createdAt      DateTime    @default(now())
  createdByUserId String?

  createdByUser User? @relation("VideoCreator", fields: [createdByUserId], references: [id], onDelete: SetNull)

  coachLinks TechniqueVideoLink[]
  userLinks  UserTechniqueVideo[]

  @@index([createdByUserId])
}


model TechniqueVideoLink {
  id           String   @id @default(cuid())
  techniqueId  String   @unique
  videoAssetId String
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())

  technique Technique  @relation(fields: [techniqueId], references: [id], onDelete: Cascade)
  video      VideoAsset @relation(fields: [videoAssetId], references: [id], onDelete: Restrict)
}



model UserTechniqueVideo {
  id           String       @id @default(cuid())
  userId       String
  techniqueId  String
  slot         UserVideoSlot
  videoAssetId String
  isActive     Boolean      @default(true)
  isLocked     Boolean      @default(false)
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt
  deletedAt    DateTime?

  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  technique Technique @relation(fields: [techniqueId], references: [id], onDelete: Cascade)
  video     VideoAsset @relation(fields: [videoAssetId], references: [id], onDelete: Restrict)

  @@unique([userId, techniqueId, slot, isActive])
  @@index([userId])
  @@index([techniqueId])
}


model UserPreference {
  id            String   @id @default(cuid())
  userId        String   @unique
  defaultBeltId String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  user        User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  defaultBelt Belt? @relation(fields: [defaultBeltId], references: [id], onDelete: SetNull)

  @@index([defaultBeltId])
}

model UserTechniqueView {
  id          String   @id @default(cuid())
  userId      String
  techniqueId String
  viewedAt    DateTime @default(now())

  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  technique Technique @relation(fields: [techniqueId], references: [id], onDelete: Cascade)

  @@unique([userId, techniqueId])
  @@index([userId])
  @@index([techniqueId])
  @@index([viewedAt])
}

model AdminAuditLog {
  id        String   @id @default(cuid())
  actorId   String
  action    String
  meta      Json?
  createdAt DateTime @default(now())

  actor User @relation("AdminActor", fields: [actorId], references: [id], onDelete: Cascade)

  @@index([actorId])
  @@index([createdAt])
}
